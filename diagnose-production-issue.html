<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Problema de Produ√ß√£o</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { margin: 15px 0; padding: 15px; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        .info { border-left: 4px solid #17a2b8; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Completo - Problema de Upload</h1>
        
        <div class="test-section error">
            <h3>üö® Problema Atual</h3>
            <p><strong>Erro:</strong> <code>Upload error: Error: Erro no upload</code></p>
            <p><strong>Status API:</strong> <span id="api-status">‚ùå 404 Not Found (nginx)</span></p>
            <p><strong>Causa prov√°vel:</strong> Backend n√£o est√° rodando no servidor de produ√ß√£o</p>
        </div>

        <div class="grid">
            <div class="test-section">
                <h3>üåê 1. Teste de Conectividade</h3>
                <button onclick="testConnectivity()">Testar Conectividade</button>
                <div id="connectivity-results"></div>
            </div>

            <div class="test-section">
                <h3>üè† 2. Teste de Hospedagem</h3>
                <button onclick="testHosting()">Verificar Hospedagem</button>
                <div id="hosting-results"></div>
            </div>

            <div class="test-section">
                <h3>üîß 3. Teste de Configura√ß√£o</h3>
                <button onclick="testConfiguration()">Verificar Configura√ß√£o</button>
                <div id="config-results"></div>
            </div>

            <div class="test-section">
                <h3>üì° 4. Teste de API</h3>
                <button onclick="testAPI()">Testar Endpoints</button>
                <div id="api-results"></div>
            </div>
        </div>

        <div class="test-section">
            <h3>üéØ 5. Diagn√≥stico Completo</h3>
            <button onclick="runFullDiagnostic()" style="background: #28a745;">üöÄ Executar Diagn√≥stico Completo</button>
            <div id="full-diagnostic"></div>
        </div>

        <div class="test-section info">
            <h3>üí° Poss√≠veis Solu√ß√µes</h3>
            <div id="solutions">
                <h4>Se o backend n√£o estiver rodando:</h4>
                <ul>
                    <li>Verificar se o processo Node.js est√° ativo no servidor</li>
                    <li>Verificar se a porta 3002 est√° aberta e acess√≠vel</li>
                    <li>Verificar logs do servidor para erros</li>
                    <li>Reiniciar o servi√ßo do backend</li>
                </ul>
                
                <h4>Se o nginx n√£o estiver configurado:</h4>
                <ul>
                    <li>Aplicar a configura√ß√£o nginx.conf criada</li>
                    <li>Verificar se o proxy_pass est√° correto</li>
                    <li>Recarregar configura√ß√£o do nginx</li>
                    <li>Verificar logs do nginx</li>
                </ul>
                
                <h4>Se for problema de deploy:</h4>
                <ul>
                    <li>Verificar se o c√≥digo foi deployado corretamente</li>
                    <li>Verificar se as vari√°veis de ambiente est√£o corretas</li>
                    <li>Verificar se as depend√™ncias foram instaladas</li>
                    <li>Verificar se o banco de dados est√° acess√≠vel</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        function addResult(containerId, type, title, message, details = null) {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-section ${type}`;
            
            let statusClass = 'status-error';
            if (type === 'success') statusClass = 'status-ok';
            if (type === 'warning') statusClass = 'status-warning';
            
            let content = `<span class="status-indicator ${statusClass}"></span><strong>${title}:</strong> ${message}`;
            if (details) {
                content += `<pre>${details}</pre>`;
            }
            
            result.innerHTML = content;
            container.appendChild(result);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function testConnectivity() {
            clearResults('connectivity-results');
            
            const tests = [
                { name: 'Site Principal', url: 'https://damafiarevenda.shop' },
                { name: 'API Health', url: 'https://damafiarevenda.shop/api/health' },
                { name: 'API Products', url: 'https://damafiarevenda.shop/api/products' },
                { name: 'Uploads Directory', url: 'https://damafiarevenda.shop/uploads/' }
            ];
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url, { method: 'HEAD' });
                    if (response.ok) {
                        addResult('connectivity-results', 'success', test.name, `‚úÖ Acess√≠vel (${response.status})`);
                    } else {
                        addResult('connectivity-results', 'error', test.name, `‚ùå Erro ${response.status}`);
                    }
                } catch (error) {
                    addResult('connectivity-results', 'error', test.name, `‚ùå ${error.message}`);
                }
            }
        }

        async function testHosting() {
            clearResults('hosting-results');
            
            try {
                const response = await fetch('https://damafiarevenda.shop');
                const html = await response.text();
                
                if (html.includes('vite')) {
                    addResult('hosting-results', 'success', 'Frontend', '‚úÖ Vite/React detectado');
                } else {
                    addResult('hosting-results', 'warning', 'Frontend', '‚ö†Ô∏è Tipo n√£o identificado');
                }
                
                if (html.includes('damafiarevenda')) {
                    addResult('hosting-results', 'success', 'Conte√∫do', '‚úÖ Conte√∫do correto carregado');
                } else {
                    addResult('hosting-results', 'error', 'Conte√∫do', '‚ùå Conte√∫do n√£o reconhecido');
                }
                
                // Verificar se h√° refer√™ncias √† API antiga
                if (html.includes('api.damafiarevenda.shop')) {
                    addResult('hosting-results', 'error', 'Configura√ß√£o API', '‚ùå Ainda usando URL antiga da API');
                } else {
                    addResult('hosting-results', 'success', 'Configura√ß√£o API', '‚úÖ URL da API corrigida');
                }
                
            } catch (error) {
                addResult('hosting-results', 'error', 'Hospedagem', `‚ùå ${error.message}`);
            }
        }

        async function testConfiguration() {
            clearResults('config-results');
            
            // Teste de CORS
            try {
                const response = await fetch('https://damafiarevenda.shop/api/health', {
                    method: 'OPTIONS'
                });
                addResult('config-results', 'info', 'CORS', `Status: ${response.status}`);
            } catch (error) {
                addResult('config-results', 'error', 'CORS', `‚ùå ${error.message}`);
            }
            
            // Teste de Headers
            try {
                const response = await fetch('https://damafiarevenda.shop');
                const server = response.headers.get('server');
                const powered = response.headers.get('x-powered-by');
                
                addResult('config-results', 'info', 'Servidor', server || 'N√£o identificado');
                if (powered) {
                    addResult('config-results', 'info', 'Powered By', powered);
                }
            } catch (error) {
                addResult('config-results', 'error', 'Headers', `‚ùå ${error.message}`);
            }
        }

        async function testAPI() {
            clearResults('api-results');
            
            const endpoints = [
                '/api/health',
                '/api/auth/login',
                '/api/products',
                '/api/upload/files',
                '/api/public/brand'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`https://damafiarevenda.shop${endpoint}`);
                    const statusText = response.ok ? '‚úÖ' : '‚ùå';
                    addResult('api-results', response.ok ? 'success' : 'error', 
                        endpoint, `${statusText} ${response.status} ${response.statusText}`);
                } catch (error) {
                    addResult('api-results', 'error', endpoint, `‚ùå ${error.message}`);
                }
            }
        }

        async function runFullDiagnostic() {
            clearResults('full-diagnostic');
            addResult('full-diagnostic', 'info', 'üîÑ Iniciando', 'Executando diagn√≥stico completo...');
            
            await testConnectivity();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testHosting();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testConfiguration();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAPI();
            
            addResult('full-diagnostic', 'success', '‚úÖ Diagn√≥stico Conclu√≠do', 
                'Verifique os resultados acima para identificar o problema.');
        }

        // Auto-executar teste b√°sico ao carregar
        window.onload = () => {
            testConnectivity();
        };
    </script>
</body>
</html>